---
# common configuration playbook

- name: 'manage ansible user .ssh directory'
  file:
    state: 'directory'
    path: '/home/devoops/.ssh/'
    owner: 'devoops'
    group: 'devoops'
    mode: '0700'

- name: 'get latest ansible keys checksum' # noqa 301
  shell:
    cmd: >
      curl -s --head "https://gitlab.cr.imson.co/api/v4/projects/107/repository/files/ansible_keys?ref=master" \
        | grep x-gitlab-content-sha256 \
        | awk "{print \$2}"
    warn: false
  register: 'ansible_keys_checksum'

- name: 'get local ansible keys checksum'
  stat:
    path: '/home/devoops/.ssh/authorized_keys'
    checksum_algorithm: 'sha256'
  register: 'local_ansible_keys_checksum'
  changed_when: 'local_ansible_keys_checksum.stat.checksum != ansible_keys_checksum.stdout'

- name: 'ensure ansible keys are latest' # noqa 503
  get_url:
    url: 'https://gitlab.cr.imson.co/cr.imson.co/ssh-keys/-/raw/master/ansible_keys'
    dest: '/home/devoops/.ssh/authorized_keys'
    owner: 'devoops'
    group: 'devoops'
    mode: '0700'
    # todo: reuse the checksum from ansible_keys_checksum.stdout somehow
    # checksum: ''
  when: 'local_ansible_keys_checksum.changed'

- name: 'install common dependencies'
  become: true
  apt:
    install_recommends: 'no'
    name:
    - 'acl' # needed for docker-ce apparently
    - 'git'
    - 'htop'
    - 'zsh'
    - 'stow'
    state: 'present'

# removing some dumb raspi-os files
- name: 'cleanup unneeded profile.d files'
  become: true
  file:
    path: '/etc/profile.d/{{ item }}'
    state: 'absent'
  with_items:
    - 'sshpwd.sh'
    - 'wifi-check.sh'

- name: 'disable the vscode repository'
  become: true
  lineinfile:
    dest: '/etc/apt/sources.list.d/vscode.list'
    regexp: '^(deb\s.+)'
    line: '# \1'
    backrefs: 'yes'
    state: 'present'

- name: 'prevent the vscode repository file from being modified'
  become: true
  file:
    path: '/etc/apt/sources.list.d/vscode.list'
    attributes: '+i'
  register: vscode_chattr
  changed_when: "'i' not in vscode_chattr.diff.before.attributes"

- name: 'remove the microsoft gpg key'
  become: true
  file:
    path: '/etc/apt/trusted.gpg.d/microsoft.gpg'
    state: 'absent'
